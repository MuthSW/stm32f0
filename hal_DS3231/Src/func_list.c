#include "stm32f0xx_hal.h"
#include "func_list.h"


extern I2C_HandleTypeDef hi2c1;

// -----------------------------------------------------------------------------------
const char str1[]="DS3231 &";
const char str2[]="STM32F0XX";
// ----------------------------------------------------------------------------------
char array[50];

char *main_menu[]={" ÂÛÕÎÄ Ñ ÌÅÍÞ ","  ÍÀÑÒÐ ÂÐÅÌ  ","  ÍÀÑÒÐ ÄÀÒÛ  ","  ÍÀÑÒÐ ÁÓÄ.  "};

char *stime_menu[]={" ÂÅÐÍÓÒ ÍÀÇÀÄ "," ÍÀÑÒÐ ×ÀÑÎÂ  "," ÍÀÑÒÐ ÌÈÍÓÒ  "};

char *alarm_menu[]={" ÍÀÑÒ ×ÀÑÎÂ Á "," ÍÀÑÒ ÌÈÍÓÒ Á "," ÂÊË.ÁÓÄÈËÜÍÈÊ"," ÇÀÏ ÇÍ ÌÈÍ Á "," ÇÀÏ ÇÍ ×ÀÑ Á "," ÎÒÊË.ÁÓÄÈËÜÍ "};

char *s_menu[]={"  +  ","  -  "," ÇÀÏ ÇÍ ÌÈÍÓÒ "," ÇÀÏ ÇÍ ×ÀÑÎÂ "," ÇÀÏ ÇÍ ÄÍß Í "," ÇÀÏ ÇÍ ×ÈÑËÀ "," ÇÀÏ ÇÍ ÌÅÑßÖ "," ÇÀÏ ÇÍ ÃÎÄÀ  "};

char *sdate_menu[]={" ÍÀÑÒ ÄÍß ÍÅÄ "," ÍÀÑÒÐ ×ÈÑËÀ  "," ÍÀÑÒÐ ÌßÑßÖÀ "," ÍÀÑÒÐ ÃÎÄÀ   "};


//-----------------------------------
extern uint8_t aTxBuffer[8];
uint8_t sec=0,min=0,hour=0,day=0,date=0,month=0,year=0,temp1=0,temp2=0;

uint8_t a1_sec=0,a1_min=0,a1_hour=0,a1_day=0,alarm_on=0;
signed char ahour_var=0,amin_var=0;
uint8_t alarm_mode=0;

signed char hour_var=0,min_var=0,day_var=0,date_var=0,month_var=0,year_var=0;
//-----------------------------------
extern uint8_t var_flag;
extern uint8_t mode_menu;
extern uint8_t mode_submenu;

float _msb=0;
// ----------------------------------------------------------------------------------

// -------çàñòàâêà--------
void lcd_headpiece(void)
{
    lcd8544_rect(1,1,82,40,1); // ïðÿìîóãîëüíèê
    lcd8544_putstr(15, 10, str1, 0); // âûâîä ïåðâîé ñòðîêè
    lcd8544_putstr(12, 18, str2, 0); // âûâîä âòîðîé ñòðîêè		
		//lcd8544_rect(0,0,83,47,1); // ïðÿìîóãîëüíèê
		
	  lcd8544_refresh(); // âûâîä áóôåðà íà ýêðàí ! áåç ýòîãî íè÷åãî âèäíî íå áóäåò !
		HAL_Delay(500);		
		lcd8544_clear(); 
	
		a1_day = I2C_Read_Byte(hi2c1,(uint16_t)0xD0, 0x0A);
	  if(a1_day==0x80) alarm_on = 1;
}

// ----------------------------------------------------------------------------------

// -------îáðàáîò÷èê ÷àñîâ--------
void rtc_handler(void)
{
	  lcd8544_line(0, 0, 0, 47, 1);
	  lcd8544_line(1, 1, 1, 46, 1);	
	  lcd8544_line(83, 0, 83, 47, 1);		
	  lcd8544_line(82, 1, 82, 46, 1);
	
	  lcd8544_line(0, 0, 83, 0, 1);
	  lcd8544_line(1, 1, 82, 1, 1);
	  lcd8544_line(0, 47, 83, 47, 1);		
	  lcd8544_line(1, 46, 82, 46, 1);	
// ----------------------------------------------------------------------------------	
	
		aTxBuffer[0]=0;
	  I2C_WriteBuffer(hi2c1,(uint16_t)0xD0,1);//Ïåðåäàäèì àäðåñ óñòðîéñòâó
		while(HAL_I2C_GetState(&hi2c1)!=HAL_I2C_STATE_READY)
		{
		}
		I2C_ReadBuffer(hi2c1,(uint16_t)0xD0,7);
//=========================================================	
    year = aTxBuffer[6];
		year = RTC_ConvertFromDec(year);	
    month = aTxBuffer[5];
		month = RTC_ConvertFromDec(month);
    date = aTxBuffer[4];
		date = RTC_ConvertFromDec(date);
    day = aTxBuffer[3];
		day = RTC_ConvertFromDec(day);		
//=========================================================		
    hour = aTxBuffer[2];
		hour = RTC_ConvertFromDec(hour);		
    min = aTxBuffer[1];
		min = RTC_ConvertFromDec(min);
    sec = aTxBuffer[0];
		sec = RTC_ConvertFromDec(sec);		
// =========================================================		
// âûâîä äíÿ íåäåëè è äàòû
// =========================================================		
   if (day==1) sprintf(array, "ÏÍ-%02d/%02d/%02d", date, month, year);
   if (day==2) sprintf(array, "ÂÒ-%02d/%02d/%02d", date, month, year);
   if (day==3) sprintf(array, "ÑÐ-%02d/%02d/%02d", date, month, year);	 
   if (day==4) sprintf(array, "×Ò-%02d/%02d/%02d", date, month, year);
   if (day==5) sprintf(array, "ÏÒ-%02d/%02d/%02d", date, month, year);
   if (day==6) sprintf(array, "ÑÁ-%02d/%02d/%02d", date, month, year);
   if (day==7) sprintf(array, "ÂÑ-%02d/%02d/%02d", date, month, year);
		
		//sprintf(array, "%02d-%02d/%02d/%02d", day, date, month, year);
		lcd8544_putstr(10,29,array,1);
    //lcd8544_refresh();	
//=========================================================		
		sprintf(array, "%02d:%02d", hour, min);
		lcd8544_putdstr(4,8,array);
    //lcd8544_refresh();		
//=========================================================		
		sprintf(array, "%02d", sec);		
	  lcd8544_putstr(68,16,array,0);		
	  //lcd8544_refresh();
//=========================================================	

		temp1 = I2C_Read_Byte(hi2c1,(uint16_t)0xD0, 0x11);
    temp2 = I2C_Read_Byte(hi2c1,(uint16_t)0xD0, 0x12);

/*    _msb = temp1 + ((temp2 >> 6) * 0.25f);	
    sprintf(array, "TEMP-%.2f", _msb);*/
		
		temp2=(temp2/128);              // ñäâèãàåì íà 6 - òî÷íîñòü 0,25 (2 áèòà)
                                    // ñäâèãàåì íà 7 - òî÷íîñòü 0,5 (1 áèò)
    temp2=temp2*5;
		sprintf(array, "ÒÅÌÏ-%02d,%01d", temp1, temp2);		
//=========================================================				
	  lcd8544_putstr(15,38,array,0);

// --------------------------------------------------------------------------------------------
    if(alarm_on==1)
		{
      lcd8544_rect(70, 7, 75, 13, 1);		
	    lcd8544_line(70, 5, 71, 5, 1);		
	    lcd8544_line(74, 5, 75, 5, 1);	
	    lcd8544_line(73, 9, 73, 10, 1);		
	    lcd8544_putpix(72, 11, 1);
		}
// --------------------------------------------------------------------------------------------

	  lcd8544_refresh();
//=========================================================			

		HAL_Delay(500);
		lcd8544_clear();

// ---------------------------------------------------------------------------------------------		
    if(alarm_on==1)
		{			
      if(a1_hour==hour)
      {
	      if(a1_min==min)
        {
	        if(sec>=1|sec<59)
					{
						if(alarm_mode!=2)
						{
							HAL_GPIO_WritePin(GPIOF, GPIO_PIN_0, GPIO_PIN_SET);
						  alarm_mode=1;
						}
					}
				  if(sec==59)
					{
						HAL_GPIO_WritePin(GPIOF, GPIO_PIN_0, GPIO_PIN_RESET);
					  alarm_mode=0;
					}
	      }
	    }		
	  }
// ---------------------------------------------------------------------------------------------
		
}

// ---------------------------------------------------------------------------------------------

void menu_func(void)
{
		lcd8544_clear();
 		//lcd8544_putstr(1,0,"ÌÅÍÞ ÍÀÑÒÐÎÉÊÈ",1);
 		lcd8544_putstr(0,2," *** ÌÅÍÞ *** ",0);

	  lcd8544_line(0, 0, 0, 47, 1);
	  lcd8544_line(83, 0, 83, 47, 1);	

	  lcd8544_line(0, 0, 83, 0, 1);		
	  lcd8544_line(0, 9, 83, 9, 1);	
	  lcd8544_line(0, 47, 83, 47, 1);	
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// îñíîâíîå ìåíþ
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
    switch(mode_menu) {
// ----------------------------------------------------------------------------------			
      case 0:
          mode_menu=2;
      break;			 
// ----------------------------------------------------------------------------------			
      case 1:
          mode_menu=5;
      break;			 
// ----------------------------------------------------------------------------------
			case 2:
      { lcd8544_putstr(0,12,main_menu[0],1);	
 		    lcd8544_putstr(0,21,main_menu[1],0);
 		    lcd8544_putstr(0,30,main_menu[2],0);				
 		    lcd8544_putstr(0,39,main_menu[3],0);	}
      break;
// ----------------------------------------------------------------------------------
      case 3:
      { lcd8544_putstr(0,12,main_menu[0],0);	
 		    lcd8544_putstr(0,21,main_menu[1],1);	
 		    lcd8544_putstr(0,30,main_menu[2],0);
 		    lcd8544_putstr(0,39,main_menu[3],0);	}
      break;
// ----------------------------------------------------------------------------------			
      case 4:
      { lcd8544_putstr(0,12,main_menu[0],0);	
 		    lcd8544_putstr(0,21,main_menu[1],0);	
 		    lcd8544_putstr(0,30,main_menu[2],1);
	 		  lcd8544_putstr(0,39,main_menu[3],0);		}
      break;			 
// ----------------------------------------------------------------------------------			
      case 5:
      { lcd8544_putstr(0,12,main_menu[0],0);	
 		    lcd8544_putstr(0,21,main_menu[1],0);	
 		    lcd8544_putstr(0,30,main_menu[2],0);
	 		  lcd8544_putstr(0,39,main_menu[3],1);		}
      break;			 
// ----------------------------------------------------------------------------------			
      case 6:
        mode_menu=2;
      break;			 
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// ïîäìåíþ íàñòðîéêè âðåìåíè			
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
      case 11:
        mode_menu=14;
      break;	
// ---------------------------------------------------------------------------------
      case 12:
      { lcd8544_putstr(0,12,stime_menu[0],1);	
 		    lcd8544_putstr(0,21,stime_menu[1],0);	
 		    lcd8544_putstr(0,30,stime_menu[2],0);	}
      break;
// ---------------------------------------------------------------------------------
      case 13:
      { lcd8544_putstr(0,12,stime_menu[0],0);	
 		    lcd8544_putstr(0,21,stime_menu[1],1);	
 		    lcd8544_putstr(0,30,stime_menu[2],0);	}
      break;
// ---------------------------------------------------------------------------------
      case 14:
      { lcd8544_putstr(0,12,stime_menu[0],0);	
 		    lcd8544_putstr(0,21,stime_menu[1],0);	
 		    lcd8544_putstr(0,30,stime_menu[2],1);	}
      break;				
// ----------------------------------------------------------------------------------			
      case 15:
        mode_menu=12;
      break;
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// ïîäìåíþ íàñòðîéêè äàòû
// ----------------------------------------------------------------------------------	
// ----------------------------------------------------------------------------------
      case 21:
        mode_menu=26;
      break;
// ----------------------------------------------------------------------------------			
      case 22:
			{
			  lcd8544_putstr(0,12,stime_menu[0],1);
 		    lcd8544_putstr(0,21,sdate_menu[0],0);	
 		    lcd8544_putstr(0,30,sdate_menu[1],0);	
 		    lcd8544_putstr(0,39,sdate_menu[2],0);				
			}				
      break;			
// ----------------------------------------------------------------------------------			
      case 23:
			{
			  lcd8544_putstr(0,12,stime_menu[0],0);
 		    lcd8544_putstr(0,21,sdate_menu[0],1);	
 		    lcd8544_putstr(0,30,sdate_menu[1],0);	
 		    lcd8544_putstr(0,39,sdate_menu[2],0);				
			}				
      break;			
// ----------------------------------------------------------------------------------			
      case 24:
			{
			  lcd8544_putstr(0,12,stime_menu[0],0);
 		    lcd8544_putstr(0,21,sdate_menu[0],0);	
 		    lcd8544_putstr(0,30,sdate_menu[1],1);	
 		    lcd8544_putstr(0,39,sdate_menu[2],0);				
			}				
      break;			
// ----------------------------------------------------------------------------------			
      case 25:
			{
			  lcd8544_putstr(0,12,stime_menu[0],0);
 		    lcd8544_putstr(0,21,sdate_menu[0],0);	
 		    lcd8544_putstr(0,30,sdate_menu[1],0);	
 		    lcd8544_putstr(0,39,sdate_menu[2],1);				
			}				
      break;			
// ----------------------------------------------------------------------------------			
      case 26:
			{
			  lcd8544_putstr(0,12,sdate_menu[0],0);
 		    lcd8544_putstr(0,21,sdate_menu[1],0);	
 		    lcd8544_putstr(0,30,sdate_menu[2],0);	
 		    lcd8544_putstr(0,39,sdate_menu[3],1);				
			}				
      break;			
// ----------------------------------------------------------------------------------			
      case 27:
        mode_menu=22;
      break;
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// ïîäìåíþ íàñòðîéêè áóäèëüíèêà
// ----------------------------------------------------------------------------------	
// ----------------------------------------------------------------------------------
      case 31:
        mode_menu=35;
      break;
// ----------------------------------------------------------------------------------			
      case 32:
      { lcd8544_putstr(0,12,stime_menu[0],1);	
 		    lcd8544_putstr(0,21,alarm_menu[0],0);
 		    lcd8544_putstr(0,30,alarm_menu[1],0);
				if(alarm_on==1)lcd8544_putstr(0,39,alarm_menu[5],0);
				else lcd8544_putstr(0,39,alarm_menu[2],0);  }
      break;
// ----------------------------------------------------------------------------------			
      case 33:
      { lcd8544_putstr(0,12,stime_menu[0],0);	
 		    lcd8544_putstr(0,21,alarm_menu[0],1);
 		    lcd8544_putstr(0,30,alarm_menu[1],0);
				if(alarm_on==1)lcd8544_putstr(0,39,alarm_menu[5],0);
				else lcd8544_putstr(0,39,alarm_menu[2],0);  }
      break;
// ----------------------------------------------------------------------------------			
      case 34:
      { lcd8544_putstr(0,12,stime_menu[0],0);	
 		    lcd8544_putstr(0,21,alarm_menu[0],0);
 		    lcd8544_putstr(0,30,alarm_menu[1],1);
				if(alarm_on==1)lcd8544_putstr(0,39,alarm_menu[5],0);
				else lcd8544_putstr(0,39,alarm_menu[2],0);  }
      break;								
// ----------------------------------------------------------------------------------			
      case 35:
      { lcd8544_putstr(0,12,stime_menu[0],0);	
 		    lcd8544_putstr(0,21,alarm_menu[0],0);
 		    lcd8544_putstr(0,30,alarm_menu[1],0);
				if(alarm_on==1)lcd8544_putstr(0,39,alarm_menu[5],1);
				else lcd8544_putstr(0,39,alarm_menu[2],1);  }
      break;								
// ----------------------------------------------------------------------------------			
      case 36:
        mode_menu=32;
      break;
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------
// 	ÍÀÑÒÐ ×ÀÑÎÂ		
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 101:
        mode_menu=105;
      break;
// ----------------------------------------------------------------------------------			
      case 102:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[3],0); 
				
        //read_hour();
        //read_min();
				hour_var = read_clock_var_lcd( hour, 0x02);				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 103:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[3],0); 

				//read_hour_var();
				read_var_lcd(hour_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 104:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[3],0); 

				//read_hour_var();
				read_var_lcd(hour_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 105:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[3],1);

				//read_hour_var();
				read_var_lcd(hour_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 106:
        mode_menu=102;
      break;
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ÌÈÍÓÒ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------				
      case 111:
        mode_menu=115;
      break;
// ----------------------------------------------------------------------------------			
      case 112:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[2],0);	
				
        //read_min();
				min_var = read_clock_var_lcd( min, 0x01);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 113:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[2],0);

				//read_min_var();
				read_var_lcd(min_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 114:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[2],0);				

				//read_min_var();
				read_var_lcd(min_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 115:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[2],1);				

				//read_min_var();
				read_var_lcd(min_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 116:
        mode_menu=112;
      break;			
			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒ ÄÍß ÍÅÄ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 121:
        mode_menu=125;
      break;
// ----------------------------------------------------------------------------------			
      case 122:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[4],0);	
				
        //read_min();
				day_var = read_clock_var_lcd( day, 0x03);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 123:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[4],0);

				//read_min_var();
				read_var_lcd(day_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 124:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[4],0);				

				//read_min_var();
				read_var_lcd(day_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 125:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[4],1);				

				//read_min_var();
				read_var_lcd(day_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 126:
        mode_menu=122;
      break;

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ×ÈÑËÀ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------		
      case 131:
        mode_menu=135;
      break;
// ----------------------------------------------------------------------------------			
      case 132:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[5],0);	
				
        //read_min();
				date_var = read_clock_var_lcd( date, 0x04);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 133:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[5],0);

				//read_min_var();
				read_var_lcd(date_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 134:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[5],0);				

				//read_min_var();
				read_var_lcd(date_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 135:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[5],1);				

				//read_min_var();
				read_var_lcd(date_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 136:
        mode_menu=132;
      break;			
			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ÌßÑßÖÀ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 141:
        mode_menu=145;
      break;
// ----------------------------------------------------------------------------------			
      case 142:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[6],0);	
				
        //read_min();
				month_var = read_clock_var_lcd( date, 0x05);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 143:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[5],0);

				//read_min_var();
				read_var_lcd(month_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 144:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[5],0);				

				//read_min_var();
				read_var_lcd(month_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 145:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[5],1);				

				//read_min_var();
				read_var_lcd(month_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 146:
        mode_menu=142;
      break;			
			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ÃÎÄÀ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------				
      case 151:
        mode_menu=155;
      break;
// ----------------------------------------------------------------------------------			
      case 152:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[7],0);	
				
        //read_min();
				year_var = read_clock_var_lcd( date, 0x06);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 153:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[7],0);

				//read_min_var();
				read_var_lcd(year_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 154:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,s_menu[7],0);				

				//read_min_var();
				read_var_lcd(year_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 155:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,s_menu[7],1);				

				//read_min_var();
				read_var_lcd(year_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 156:
        mode_menu=152;
      break;			
		
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ×ÀÑÎÂ ÁÓÄÈËÜÍÈÊÀ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------				
      case 161:
        mode_menu=165;
      break;
// ----------------------------------------------------------------------------------			
      case 162:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[4],0);	
				
        //read_min();
				ahour_var = read_clock_var_lcd( date, 0x09);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 163:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[4],0);

				//read_min_var();
				read_var_lcd(ahour_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 164:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,alarm_menu[4],0);

				//read_min_var();
				read_var_lcd(ahour_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 165:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[4],1);

				//read_min_var();
				read_var_lcd(ahour_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 166:
        mode_menu=162;
      break;			

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	
// ÍÀÑÒÐ ÌÈÍÓÒ ÁÓÄÈËÜÍÈÊÀ
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------				
      case 171:
        mode_menu=175;
      break;
// ----------------------------------------------------------------------------------			
      case 172:
			{
				lcd8544_putstr(0,12,stime_menu[0],1);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[3],0);	
				
        //read_min();
				amin_var = read_clock_var_lcd( date, 0x08);
				
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 173:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],1);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[3],0);

				//read_min_var();
				read_var_lcd(amin_var);
			}
      break;	
// ----------------------------------------------------------------------------------			
      case 174:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],1);
 		    lcd8544_putstr(0,39,alarm_menu[3],0);

				//read_min_var();
				read_var_lcd(amin_var);
			}
      break;
// ----------------------------------------------------------------------------------			
      case 175:
			{
				lcd8544_putstr(0,12,stime_menu[0],0);		
 		    lcd8544_putstr(0,21,s_menu[0],0);	
 		    lcd8544_putstr(0,30,s_menu[1],0);
 		    lcd8544_putstr(0,39,alarm_menu[3],1);

				//read_min_var();
				read_var_lcd(amin_var);			
			}
      break;
// ----------------------------------------------------------------------------------			
      case 176:
        mode_menu=172;
      break;			




		}			
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------		 
// ----------------------------------------------------------------------------------			
    lcd8544_refresh();	


// **********************************************************************************
// **********************************************************************************
// **********************************************************************************
// **********************************************************************************
// **********************************************************************************
		 
		 
    if(var_flag==4)	
		{
     switch(mode_menu) {
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------
      case 2:
			 {
				mode_menu = 0;
			  var_flag = 0;
        lcd8544_clear();
			 }
      break;
// ----------------------------------------------------------------------------------
      case 3:
			 {
				 mode_menu = 12;
			   var_flag = 7;
			 }
      break;
// ----------------------------------------------------------------------------------			
      case 4:
			 {  
				 mode_menu = 22;
				 var_flag = 7;
			 }
      break;
// ----------------------------------------------------------------------------------			
      case 5:
			 {  
				 mode_menu = 32;
				 var_flag = 7;
			 }
      break;
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 12:
			 {
				 mode_menu = 2;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 13:
			 {
				 mode_menu = 102;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 14:
			 {
				 mode_menu = 112;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 22:
			 {
				 mode_menu = 2;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 23:
			 {
				 mode_menu = 122;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 24:
			 {
				 mode_menu = 132;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 25:
			 {
				 mode_menu = 142;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 26:
			 {
				 mode_menu = 152;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 32:
			 {
				 mode_menu = 2;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 33:
			 {
				 mode_menu = 162;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 34:
			 {
				 mode_menu = 172;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 35:
			 {
				 mode_menu = 32;
				 if(alarm_on==0)
				 {
					 alarm_on=1;
			     I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x0A,0x80);					 
				 }
				 else 
				 {
					 alarm_on=0;
           I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x0A,0x00);
				 }					 
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 102:
			 {
				 mode_menu = 12;
			   var_flag = 7;
			 }			
      break;
// ----------------------------------------------------------------------------------			
      case 103:
			 {
         hour_var++;
			   var_flag = 7;
				 if(hour_var>23)hour_var=0;				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 104:
			 {
         hour_var--;
			   var_flag = 7;
				 if(hour_var<0)hour_var=23;				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 105:
			 {
         // ------set hour------
         hour_var = RTC_ConvertFromBinDec(hour_var);
			   var_flag = 9;
				 mode_menu = 102;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x02,hour_var);
				 
			 }			
      break;			 

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 112:
			 {
				 mode_menu = 12;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 113:
			 {
         min_var++;
			   var_flag = 7;
				 if(min_var>59)min_var=0;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 114:
			 {
         min_var--;
			   var_flag = 7;
				 if(min_var<0)min_var=59;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 115:
			 {				 
         // ------set min------
         min_var = RTC_ConvertFromBinDec(min_var);
			   var_flag = 9;
				 mode_menu = 112;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x01,min_var);			 					 
			 }			
      break;			 

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 122:
			 {
				 mode_menu = 22;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 123:
			 {
         day_var++;
			   var_flag = 7;
				 if(day_var>7)day_var=1;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 124:
			 {
         day_var--;
			   var_flag = 7;
				 if(day_var<1)min_var=7;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 125:
			 {				 
         // ------set day------
         day_var = RTC_ConvertFromBinDec(day_var);
			   var_flag = 9;
				 mode_menu = 122;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x03,day_var);			 					 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------				 

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 132:
			 {
				 mode_menu = 22;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 133:
			 {
         date_var++;
			   var_flag = 7;
				 if(date_var>31)date_var=1;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 134:
			 {
         date_var--;
			   var_flag = 7;
				 if(date_var<1)date_var=31;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 135:
			 {				 
         // ------set date------
         date_var = RTC_ConvertFromBinDec(date_var);
			   var_flag = 9;
				 mode_menu = 132;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x04,date_var);			 					 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 142:
			 {
				 mode_menu = 22;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 143:
			 {
         month_var++;
			   var_flag = 7;
				 if(month_var>12)month_var=1;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 144:
			 {
         month_var--;
			   var_flag = 7;
				 if(month_var<1)month_var=12;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 145:
			 {				 
         // ------set month------
         month_var = RTC_ConvertFromBinDec(month_var);
			   var_flag = 9;
				 mode_menu = 142;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x05,month_var);			 					 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	

// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 152:
			 {
				 mode_menu = 22;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 153:
			 {
         year_var++;
			   var_flag = 7;
				 if(year_var>99)year_var=0;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 154:
			 {
         year_var--;
			   var_flag = 7;
				 if(year_var<0)year_var=99;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 155:
			 {				 
         // ------set year------
         year_var = RTC_ConvertFromBinDec(year_var);
			   var_flag = 9;
				 mode_menu = 152;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x06,year_var);			 					 
			 }			
      break;
			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 162:
			 {
				 mode_menu = 32;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 163:
			 {
         ahour_var++;
			   var_flag = 7;
				 if(ahour_var>23)ahour_var=0;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 164:
			 {
         ahour_var--;
			   var_flag = 7;
				 if(ahour_var<0)ahour_var=23;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 165:
			 {				 
         // ------set alarm hour------
         ahour_var = RTC_ConvertFromBinDec(ahour_var);
			   var_flag = 9;
				 mode_menu = 162;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x09,ahour_var);			 					 
			 }			
      break;			 
			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
      case 172:
			 {
				 mode_menu = 32;
			   var_flag = 7;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 173:
			 {
         amin_var++;
			   var_flag = 7;
				 if(amin_var>59)amin_var=0;
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 174:
			 {
         amin_var--;
			   var_flag = 7;
				 if(amin_var<0)amin_var=59;
				 
				 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
      case 175:
			 {				 
         // ------set alarm hour------
         amin_var = RTC_ConvertFromBinDec(amin_var);
			   var_flag = 9;
				 mode_menu = 172;				 
			   I2C_Write_Byte(hi2c1,(uint16_t)0xD0,0x08,amin_var);			 					 
			 }			
      break;			 
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------			
// ----------------------------------------------------------------------------------	

			 
			 
// ----------------------------------------------------------------------------------			
      default  :
      break;
			
       }
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------			 
		}	
	
}	

// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
void read_var_lcd(signed char clock_var)
{		
		sprintf(array, "%02d", clock_var);
		lcd8544_putstr(50,25,array,1);	
}

// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------	

signed char read_clock_var_lcd( uint8_t ds3231_var, uint8_t addr)
{		
// ----------------------------------------------------------------------------------		
	  signed char clock_var=0;
	
    ds3231_var = RTC_ConvertFromDec(I2C_Read_Byte(hi2c1,(uint16_t)0xD0, addr));		

		sprintf(array, "%02d", ds3231_var);
		lcd8544_putstr(50,25,array,1);

		clock_var = ds3231_var;	
	  return clock_var;
}

// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------	

void read_alarm(void)
{
	  if(alarm_mode==1)
		{
			HAL_GPIO_WritePin(GPIOF, GPIO_PIN_0, GPIO_PIN_RESET);
			alarm_mode=2;
		}
	
	  lcd8544_line(0, 0, 0, 47, 1);
	  lcd8544_line(83, 0, 83, 47, 1);		
	
	  lcd8544_line(0, 0, 83, 0, 1);
	  lcd8544_line(0, 47, 83, 47, 1);	
	
		a1_min = RTC_ConvertFromDec(I2C_Read_Byte(hi2c1,(uint16_t)0xD0, 0x08));
    a1_hour = RTC_ConvertFromDec(I2C_Read_Byte(hi2c1,(uint16_t)0xD0, 0x09));
	
		lcd8544_putstr(17,7,"ÁÓÄÈËÜÍÈÊ",0);
		if(alarm_on==1)lcd8544_putstr(22,16,"ÂÊËÞ×ÅÍ",0);
    else lcd8544_putstr(17,16,"ÎÒÊËÞ×ÅÍ",0);
	  sprintf(array, "%02d:%02d", a1_hour, a1_min);
		lcd8544_putstr(27,25,array,1);

		lcd8544_refresh(); // âûâîä áóôåðà íà ýêðàí ! áåç ýòîãî íè÷åãî âèäíî íå áóäåò !
		HAL_Delay(2000);		
		lcd8544_clear();
	
    var_flag = 0;	
}

// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------		
// ----------------------------------------------------------------------------------	

void lcd_led(void)
{
			HAL_GPIO_TogglePin(GPIOF, GPIO_PIN_1); // ïîäñâåòêà äèñïëåÿ
			var_flag = 0;	
}

